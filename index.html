<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tesorer√≠a - Cuadrilla de Negritos Ni√±o Jes√∫s de Paucarbambilla</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

    <!-- Chosen Palette: Ivory, Deep Velvet Blue and Andean Gold -->
    <!-- Application Structure Plan:
         1. Dashboard Hol√≠stico: Resumen de todos los "libros" o fuentes de ingreso.
         2. Gesti√≥n de Compa√±eros: Mantenimiento de integrantes y sus links personales.
         3. Registro Multicanal: El portal del integrante y el m√°ster permiten elegir el origen del fondo (Cuota, Actividad, Donaci√≥n, Auspicio).
         4. Libro Diario Universal: Una tabla estilo "Excel" con filtros potentes por categor√≠a para separar polladas de aportes extra.
         5. State Management: Un array de 'ledger' que centraliza toda la contabilidad permitiendo c√°lculos din√°micos de balance.
    -->

    <style>
        :root {
            --color-ivory: #FAF9F3;
            --color-velvet: #0F172A;
            --color-gold-deep: #92400E;
            --color-gold-light: #F59E0B;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-ivory);
            background-image: radial-gradient(#92400e 0.5px, transparent 0.5px);
            background-size: 30px 30px;
        }

        .font-serif { font-family: 'Playfair Display', serif; }

        .gold-line {
            height: 4px;
            background: linear-gradient(90deg, #92400E 0%, #F59E0B 50%, #92400E 100%);
        }

        .chart-container { position: relative; width: 100%; height: 280px; }

        .nav-active {
            background-color: white !important;
            color: var(--color-velvet) !important;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .animate-fade { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilo Hoja Contable */
        .excel-table th { background-color: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; font-size: 0.7rem; }
        .excel-table td { border: 1px solid #f1f5f9; padding: 0.75rem; }
        
        /* Scan IA Effect */
        .scan-line {
            width: 100%; height: 2px; background: var(--color-gold-light); position: absolute;
            top: 0; left: 0; box-shadow: 0 0 15px var(--color-gold-light);
            animation: scan 2s infinite linear; display: none;
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
    </style>
</head>
<body class="text-slate-800">

    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. Icons are Unicode characters. -->

    <!-- VISTA MAESTRA (ADMIN) -->
    <div id="wrapper-master">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
            <div class="gold-line"></div>
            <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-slate-900 rounded-xl flex items-center justify-center text-3xl border-2 border-amber-500 shadow-xl">üé≠</div>
                    <div>
                        <h1 class="font-serif text-xl font-black text-slate-900 leading-none uppercase">Tesorer√≠a Central</h1>
                        <p class="text-[10px] font-bold text-amber-700 uppercase tracking-[0.3em] mt-1">Ni√±o Jes√∫s de Paucarbambilla</p>
                    </div>
                </div>
                
                <nav id="main-nav" class="flex items-center gap-1 bg-slate-100 p-1 rounded-xl">
                    <button onclick="router('dashboard', this)" class="nav-btn px-4 py-2 text-xs font-black rounded-lg transition-all nav-active">RESUMEN</button>
                    <button onclick="router('integrantes', this)" class="nav-btn px-4 py-2 text-xs font-black rounded-lg transition-all text-slate-500">COMPA√ëEROS</button>
                    <button onclick="router('contabilidad', this)" class="nav-btn px-4 py-2 text-xs font-black rounded-lg transition-all text-slate-500">LIBRO DIARIO</button>
                </nav>

                <div class="flex items-center gap-3 border-l pl-4 border-slate-200">
                    <button onclick="location.reload()" class="text-[10px] font-black bg-slate-800 text-white px-3 py-1.5 rounded-lg hover:bg-black transition">CERRAR</button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-6 space-y-8 pb-20">
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view-content animate-fade space-y-8">
                <section class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm border-l-8 border-l-slate-900">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="font-serif text-3xl font-black text-slate-900">Balance Maestro</h2>
                            <p class="text-slate-500 text-sm mt-1">Consolidado de todas las fuentes de ingreso y egreso.</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-slate-400 uppercase">Saldo Actual Aprobado</p>
                            <h3 id="kpi-balance" class="text-4xl font-black text-slate-900">S/. 0.00</h3>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-8">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <p class="text-[9px] font-black text-slate-400 uppercase">Integrantes</p>
                            <h4 id="kpi-members" class="text-xl font-bold text-slate-800">--</h4>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <p class="text-[9px] font-black text-slate-400 uppercase">Por Validar</p>
                            <h4 id="kpi-pending" class="text-xl font-bold text-amber-600">S/. 0.00</h4>
                        </div>
                        <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                            <p class="text-[9px] font-black text-emerald-700 uppercase">Ingresos Totales</p>
                            <h4 id="kpi-incomes" class="text-xl font-bold text-emerald-700">S/. 0.00</h4>
                        </div>
                        <div class="bg-rose-50 p-4 rounded-xl border border-rose-100">
                            <p class="text-[9px] font-black text-rose-700 uppercase">Egresos Totales</p>
                            <h4 id="kpi-expenses" class="text-xl font-bold text-rose-700">S/. 0.00</h4>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                        <h4 class="font-serif text-lg font-bold mb-6">Comparativa por Tipo de Ingreso</h4>
                        <div class="chart-container"><canvas id="barChart"></canvas></div>
                    </div>
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                        <h4 class="font-serif text-lg font-bold mb-6">Distribuci√≥n de Fondos</h4>
                        <div class="chart-container"><canvas id="donutChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- INTEGRANTES -->
            <div id="view-integrantes" class="view-content hidden animate-fade space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h2 class="font-serif text-3xl font-black text-slate-900">Compa√±eros Integrantes</h2>
                        <p class="text-slate-500 text-sm">Registro de la cuadrilla y gesti√≥n de acceso a pagos.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleModal('modal-nuevo', true)" class="bg-slate-900 text-white px-5 py-3 rounded-xl font-bold text-xs hover:bg-black transition shadow-lg">‚ûï AGREGAR COMPA√ëERO</button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase font-black tracking-widest border-b">
                            <tr>
                                <th class="px-8 py-5">Compa√±ero</th>
                                <th class="px-8 py-5">Enlace de Pago</th>
                                <th class="px-8 py-5 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="memberTable" class="divide-y divide-slate-100">
                            <!-- JS Din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- LIBRO DIARIO (MULTI-HOJA) -->
            <div id="view-contabilidad" class="view-content hidden animate-fade space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                    <div>
                        <h2 class="font-serif text-3xl font-black text-slate-900">Libro Contable Maestro</h2>
                        <p class="text-slate-500 text-sm italic">Consolidado universal de movimientos.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <select id="filter-ledger" onchange="renderLedger()" class="bg-white border border-slate-200 rounded-lg px-4 py-2 text-xs font-bold outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="todos">Todas las Hojas</option>
                            <option value="compa√±ero">Aportes Compa√±eros</option>
                            <option value="actividad">Actividades (Polladas/Fiestas)</option>
                            <option value="donacion">Aportes Extra (Donantes)</option>
                            <option value="auspicio">Auspiciadores</option>
                            <option value="egreso">Egresos / Gastos</option>
                        </select>
                        <button onclick="toggleModal('modal-egreso', true)" class="bg-rose-600 text-white px-4 py-2 rounded-lg text-xs font-black hover:bg-rose-700 transition">‚ûñ REGISTRAR GASTO</button>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left excel-table">
                            <thead>
                                <tr class="uppercase tracking-widest">
                                    <th class="px-6 py-4">Fecha</th>
                                    <th class="px-6 py-4">Origen / Libro</th>
                                    <th class="px-6 py-4">Descripci√≥n / Compa√±ero</th>
                                    <th class="px-6 py-4">Monto</th>
                                    <th class="px-6 py-4 text-center">Estado</th>
                                    <th class="px-6 py-4 text-center">Gesti√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="ledger-body" class="text-sm">
                                <!-- JS Din√°mico -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- VISTA DEL PORTAL INTEGRANTE -->
    <div id="wrapper-member" class="hidden min-h-screen bg-slate-50 pb-20">
        <header class="bg-white border-b border-slate-100 px-6 py-4 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üé≠</span>
                <span class="font-serif font-black text-slate-800 uppercase tracking-tight">Portal del Compa√±ero</span>
            </div>
            <button onclick="exitMemberView()" class="text-[10px] font-black bg-slate-800 text-white px-4 py-2 rounded-lg">REGRESAR AL M√ÅSTER</button>
        </header>

        <main class="max-w-4xl mx-auto p-6 space-y-8 animate-fade">
            <div class="bg-white p-10 rounded-3xl border border-slate-200 shadow-xl border-t-8 border-t-amber-600 text-center relative overflow-hidden">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Bienvenido a la Tesorer√≠a</p>
                <h2 id="member-portal-name" class="font-serif text-4xl font-black text-slate-900 mt-2 tracking-tight">--</h2>
                <div id="member-portal-role" class="text-xs font-bold text-amber-600 mt-2 uppercase tracking-widest">--</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Paso 1 -->
                <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm space-y-4">
                    <h3 class="font-black text-xs uppercase text-slate-400 tracking-widest">1. Subir V√°ucher o Ticket</h3>
                    <div class="relative border-2 border-dashed border-slate-200 rounded-2xl p-14 text-center cursor-pointer hover:border-amber-500 transition-all overflow-hidden group" onclick="simulateFileUpload()">
                        <div id="scan-line" class="scan-line"></div>
                        <div id="upload-content">
                            <span class="text-6xl block mb-4 group-hover:scale-110 transition-transform">üì∏</span>
                            <p class="text-xs font-bold text-slate-600">Click para adjuntar imagen</p>
                        </div>
                        <div id="upload-preview" class="hidden">
                            <div class="w-full h-40 bg-slate-100 rounded-xl flex items-center justify-center font-bold text-slate-400 text-xs uppercase border border-slate-200">V√°ucher Cargado</div>
                            <p class="text-[10px] font-bold text-emerald-600 mt-3 italic animate-pulse">Imagen detectada correctamente</p>
                        </div>
                    </div>
                    <button id="btn-ia" disabled onclick="simulateOCR()" class="w-full py-4 bg-amber-50 text-amber-700 rounded-2xl font-black text-xs flex items-center justify-center gap-2 disabled:opacity-50">
                        ü§ñ LECTURA INTELIGENTE (IA)
                    </button>
                </div>

                <!-- Paso 2 -->
                <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm space-y-4">
                    <h3 class="font-black text-xs uppercase text-slate-400 tracking-widest">2. Clasificaci√≥n del Aporte</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[9px] font-black text-slate-400 ml-2 uppercase">Tipo de Aporte</label>
                            <select id="mem-type" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm font-black outline-none focus:ring-2 focus:ring-amber-500">
                                <option value="compa√±ero">Mi Cuota Mensual</option>
                                <option value="actividad">Venta Actividad (Pollada/Parrillada)</option>
                                <option value="donacion">Aporte de Amigo / Tercero</option>
                                <option value="auspicio">Auspicio de Empresa</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[9px] font-black text-slate-400 ml-2 uppercase">Monto S/.</label>
                                <input type="number" id="mem-amount" placeholder="0.00" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm font-black focus:ring-2 focus:ring-amber-500 outline-none">
                            </div>
                            <div>
                                <label class="text-[9px] font-black text-slate-400 ml-2 uppercase">Fecha</label>
                                <input type="date" id="mem-date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm font-bold outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-slate-400 ml-2 uppercase">Descripci√≥n / Glosa</label>
                            <input type="text" id="mem-ref" placeholder="Ej: Pago Pollada 10 tickets o Donaci√≥n Sr. Rojas" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm font-bold focus:ring-2 focus:ring-amber-500 outline-none">
                        </div>
                        <button onclick="submitVoucher()" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xs hover:bg-black transition shadow-xl mt-4">ENVIAR A REVISI√ìN DE TESORER√çA</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALES -->
    <!-- Modal Nuevo Integrante -->
    <div id="modal-nuevo" class="fixed inset-0 bg-slate-900/60 hidden z-[60] flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white rounded-3xl max-w-md w-full p-8 shadow-2xl border-t-[10px] border-amber-600 animate-fade">
            <h3 class="font-serif text-2xl font-black text-center mb-6">Nuevo Compa√±ero</h3>
            <div class="space-y-4">
                <input type="text" id="inp-nombre" placeholder="Nombre completo..." class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-bold outline-none">
                <select id="inp-cargo" class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-bold appearance-none outline-none">
                    <option>Negrito Gu√≠a</option><option>Trasgu√≠a</option><option>Negrito Pampa</option><option>Abanderado</option>
                </select>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="toggleModal('modal-nuevo', false)" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-[10px] uppercase">Cancelar</button>
                <button onclick="addMember()" class="flex-[2] py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] shadow-xl uppercase">Registrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Gasto -->
    <div id="modal-egreso" class="fixed inset-0 bg-slate-900/60 hidden z-[60] flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white rounded-3xl max-w-md w-full p-8 shadow-2xl border-t-[10px] border-rose-600 animate-fade">
            <h3 class="font-serif text-2xl font-black text-center mb-6 text-rose-800">Registrar Gasto</h3>
            <div class="space-y-4">
                <input type="text" id="exp-desc" placeholder="¬øEn qu√© se gast√≥? (Ej: Pago a la Banda)" class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-bold outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="exp-amount" placeholder="Monto S/." class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-black outline-none">
                    <input type="date" id="exp-date" class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-bold outline-none">
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="toggleModal('modal-egreso', false)" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-[10px] uppercase">Cancelar</button>
                <button onclick="addExpense()" class="flex-[2] py-4 bg-rose-600 text-white rounded-2xl font-black text-[10px] shadow-xl uppercase">Guardar Gasto</button>
            </div>
        </div>
    </div>

    <!-- L√ìGICA DE LA APLICACI√ìN -->
    <script>
        // --- BASE DE DATOS LOCAL ---
        let members = [
            { id: 1, name: 'Ra√∫l Espinoza', role: 'Negrito Gu√≠a', slug: 'raul-espinoza-pauc' },
            { id: 2, name: 'Humberto Rojas', role: 'Trasgu√≠a', slug: 'humberto-rojas-pauc' }
        ];

        let ledger = [
            { id: 101, date: '2024-02-01', name: 'Mantenimiento Trajes', ref: 'Limpieza de plumas', amount: 250.00, status: 'aprobado', type: 'egreso', book: 'egreso' },
            { id: 102, date: '2024-02-05', name: 'Auspicio BCP', ref: 'Publicidad en Programa', amount: 500.00, status: 'aprobado', type: 'ingreso', book: 'auspicio' }
        ];

        let currentActiveMember = null;
        let activeCharts = {};

        // --- NAVEGACI√ìN ---
        function router(viewId, btnEl) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            const view = document.getElementById(`view-${viewId}`);
            if (view) view.classList.remove('hidden');

            if (btnEl) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
                btnEl.classList.add('nav-active');
            }

            if (viewId === 'dashboard') updateDashboard();
            if (viewId === 'integrantes') renderMembers();
            if (viewId === 'contabilidad') renderLedger();
        }

        // --- DASHBOARD DIN√ÅMICO ---
        function updateDashboard() {
            const approvedMovements = ledger.filter(m => m.status === 'aprobado');
            
            const totalIncomes = approvedMovements.filter(m => m.type === 'ingreso').reduce((s, m) => s + m.amount, 0);
            const totalExpenses = approvedMovements.filter(m => m.type === 'egreso').reduce((s, m) => s + m.amount, 0);
            const balance = totalIncomes - totalExpenses;

            const pendingAmount = ledger.filter(m => m.status === 'pendiente').reduce((s, m) => s + m.amount, 0);

            document.getElementById('kpi-balance').innerText = `S/. ${balance.toFixed(2)}`;
            document.getElementById('kpi-pending').innerText = `S/. ${pendingAmount.toFixed(2)}`;
            document.getElementById('kpi-incomes').innerText = `S/. ${totalIncomes.toFixed(2)}`;
            document.getElementById('kpi-expenses').innerText = `S/. ${totalExpenses.toFixed(2)}`;
            document.getElementById('kpi-members').innerText = `${members.length} Compa√±eros`;

            // Preparar datos para gr√°ficos
            const groups = { compa√±ero: 0, actividad: 0, donacion: 0, auspicio: 0 };
            approvedMovements.forEach(m => { if(m.type === 'ingreso') groups[m.book] += m.amount; });

            initCharts(groups, totalIncomes, totalExpenses);
        }

        // --- RENDERIZADO ---
        function renderMembers() {
            const table = document.getElementById('memberTable');
            table.innerHTML = '';
            members.forEach(m => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50";
                tr.innerHTML = `
                    <td class="px-8 py-6">
                        <p class="font-black text-slate-800 text-sm tracking-tight">${m.name}</p>
                        <p class="text-[10px] font-bold text-amber-600 uppercase tracking-tighter">${m.role}</p>
                    </td>
                    <td class="px-8 py-6">
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded">paucarbambilla.app/${m.slug}</span>
                            <button onclick="copyToClipboard('${m.slug}')" class="text-[8px] bg-slate-900 text-white px-3 py-1 rounded hover:bg-black transition font-black uppercase">Copiar</button>
                        </div>
                    </td>
                    <td class="px-8 py-6 text-center">
                        <button onclick="enterMemberView(${m.id})" class="text-[9px] font-black bg-amber-50 text-amber-700 px-4 py-2 rounded-lg border border-amber-200 hover:bg-amber-600 hover:text-white transition uppercase">Abonar / Actividad</button>
                    </td>
                `;
                table.appendChild(tr);
            });
        }

        function renderLedger() {
            const body = document.getElementById('ledger-body');
            const filter = document.getElementById('filter-ledger').value;
            body.innerHTML = '';

            const filteredLedger = filter === 'todos' ? ledger : ledger.filter(l => l.book === filter);

            filteredLedger.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(m => {
                const tr = document.createElement('tr');
                const isPending = m.status === 'pendiente';
                
                const bookLabel = {
                    compa√±ero: 'üë§ Compa√±ero',
                    actividad: 'üçó Actividad',
                    donacion: 'üíù Extra/Amigo',
                    auspicio: 'üè¢ Auspicio',
                    egreso: 'üìâ Gasto'
                };

                tr.innerHTML = `
                    <td class="px-6 py-4 font-mono text-xs text-slate-400">${m.date}</td>
                    <td class="px-6 py-4"><span class="text-[10px] font-black uppercase text-slate-500">${bookLabel[m.book]}</span></td>
                    <td class="px-6 py-4">
                        <p class="font-bold text-slate-700">${m.name}</p>
                        <p class="text-[10px] text-slate-400 truncate max-w-xs">${m.ref}</p>
                    </td>
                    <td class="px-6 py-4 font-black ${m.type === 'ingreso' ? 'text-emerald-600' : 'text-rose-600'}">S/. ${m.amount.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-1 rounded-lg text-[9px] font-black uppercase ${isPending ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-emerald-100 text-emerald-700 border border-emerald-200'}">
                            ${m.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        ${isPending ? `<button onclick="approveLedger(${m.id})" class="text-[9px] bg-emerald-600 text-white px-3 py-1.5 rounded-lg font-black hover:bg-emerald-700 transition shadow-sm">VALIDAR</button>` : '<span class="text-slate-300">‚úÖ</span>'}
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        // --- L√ìGICA DE NEGOCIO ---
        function approveLedger(id) {
            const entry = ledger.find(l => l.id === id);
            if (entry) {
                entry.status = 'aprobado';
                renderLedger();
                updateDashboard();
            }
        }

        function addMember() {
            const name = document.getElementById('inp-nombre').value;
            const cargo = document.getElementById('inp-cargo').value;
            if (!name) return alert("Ingrese el nombre del compa√±ero");
            const slug = name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-') + '-' + Math.floor(Math.random() * 999);
            members.push({ id: Date.now(), name, role: cargo, slug });
            toggleModal('modal-nuevo', false);
            renderMembers();
        }

        function addExpense() {
            const desc = document.getElementById('exp-desc').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const date = document.getElementById('exp-date').value || new Date().toISOString().split('T')[0];

            if (!desc || !amount) return alert("Complete los datos del gasto");

            ledger.push({
                id: Date.now(),
                date: date,
                name: desc,
                ref: 'Gasto registrado por administraci√≥n',
                amount: amount,
                status: 'aprobado',
                type: 'egreso',
                book: 'egreso'
            });

            toggleModal('modal-egreso', false);
            updateDashboard();
            renderLedger();
        }

        function submitVoucher() {
            const amount = parseFloat(document.getElementById('mem-amount').value);
            const bookType = document.getElementById('mem-type').value;
            if (!amount) return alert("Ingrese el monto del abono");
            
            ledger.push({
                id: Date.now(),
                date: document.getElementById('mem-date').value || new Date().toISOString().split('T')[0],
                name: currentActiveMember.name,
                ref: document.getElementById('mem-ref').value || `Aporte v√≠a portal`,
                amount: amount,
                status: 'pendiente',
                type: 'ingreso',
                book: bookType
            });

            alert(`Gracias ${currentActiveMember.name}. Reporte enviado satisfactoriamente.`);
            exitMemberView();
        }

        // --- SIMULACI√ìN DE PORTAL ---
        function enterMemberView(id) {
            currentActiveMember = members.find(m => m.id === id);
            document.getElementById('wrapper-master').classList.add('hidden');
            document.getElementById('wrapper-member').classList.remove('hidden');
            document.getElementById('member-portal-name').innerText = currentActiveMember.name;
            document.getElementById('member-portal-role').innerText = currentActiveMember.role;
        }

        function exitMemberView() {
            document.getElementById('wrapper-master').classList.remove('hidden');
            document.getElementById('wrapper-member').classList.add('hidden');
            router('dashboard');
        }

        function simulateFileUpload() {
            document.getElementById('upload-content').classList.add('hidden');
            document.getElementById('upload-preview').classList.remove('hidden');
            document.getElementById('btn-ia').disabled = false;
        }

        function simulateOCR() {
            document.getElementById('scan-line').style.display = 'block';
            setTimeout(() => {
                document.getElementById('scan-line').style.display = 'none';
                document.getElementById('mem-amount').value = 100.00;
                document.getElementById('mem-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('mem-ref').value = "TRANSFERENCIA BCP - OPERACI√ìN 122";
            }, 1500);
        }

        // --- UTILIDADES ---
        function toggleModal(id, show) { document.getElementById(id).classList.toggle('hidden', !show); }
        function copyToClipboard(slug) { alert("Link personal generado: paucarbambilla.app/" + slug); }

        function initCharts(groups, ingresos, egresos) {
            if (activeCharts.bar) activeCharts.bar.destroy();
            if (activeCharts.donut) activeCharts.donut.destroy();

            // Gr√°fico de Barras por Tipo de Ingreso
            activeCharts.bar = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: ['Compa√±eros', 'Actividades', 'Aportes Extra', 'Auspicios'],
                    datasets: [{
                        label: 'Ingresos Acumulados S/.',
                        data: [groups.compa√±ero, groups.actividad, groups.donacion, groups.auspicio],
                        backgroundColor: '#0F172A',
                        borderRadius: 8
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: { borderDash: [5,5] } }, x: { grid: { display: false } } }
                }
            });

            // Gr√°fico de Dona: Balance
            activeCharts.donut = new Chart(document.getElementById('donutChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Ingresos Totales', 'Gastos Totales'],
                    datasets: [{
                        data: [ingresos, egresos],
                        backgroundColor: ['#10b981', '#f43f5e'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '75%',
                    plugins: { legend: { position: 'bottom', labels: { font: { weight: 'bold' } } } }
                }
            });
        }

        // Inicio por defecto
        window.onload = () => router('dashboard');
    </script>
</body>
</html>
