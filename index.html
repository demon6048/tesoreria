<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tesorer√≠a - Cuadrilla de Negritos Ni√±o Jes√∫s de Paucarbambilla</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

    <!-- Chosen Palette: Ivory, Deep Velvet Blue and Andean Gold -->
    <!-- Application Structure Plan:
         1. Dise√±o Mobile-First: Uso de clases responsivas de Tailwind para asegurar que el sistema sea usable en celulares.
         2. Navegaci√≥n Adaptativa: Men√∫ superior que se ajusta a diferentes tama√±os de pantalla.
         3. Sistema de "Hojas" Contables: Categorizaci√≥n estricta por conceptos (Compa√±eros, Polladas, Donantes, Auspicios).
         4. Dashboard Interactivo: Gr√°ficos que se redimensionan y KPIs que se apilan en dispositivos m√≥viles.
         5. Libro Diario estilo Excel: Vista de tabla optimizada con scroll horizontal para m√≥viles.
    -->

    <style>
        :root {
            --color-ivory: #FAF9F3;
            --color-velvet: #0F172A;
            --color-gold-deep: #92400E;
            --color-gold-light: #F59E0B;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-ivory);
            background-image: radial-gradient(#92400e 0.5px, transparent 0.5px);
            background-size: 30px 30px;
        }

        .font-serif { font-family: 'Playfair Display', serif; }

        .gold-line {
            height: 4px;
            background: linear-gradient(90deg, #92400E 0%, #F59E0B 50%, #92400E 100%);
        }

        .chart-container { position: relative; width: 100%; height: 250px; }
        @media (min-width: 768px) { .chart-container { height: 300px; } }

        .nav-active {
            background-color: white !important;
            color: var(--color-velvet) !important;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .animate-fade { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilo Hoja Contable */
        .excel-table th { background-color: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; font-size: 0.65rem; white-space: nowrap; }
        .excel-table td { border: 1px solid #f1f5f9; padding: 0.6rem; white-space: nowrap; }
        
        .scan-line {
            width: 100%; height: 2px; background: var(--color-gold-light); position: absolute;
            top: 0; left: 0; box-shadow: 0 0 15px var(--color-gold-light);
            animation: scan 2s infinite linear; display: none;
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        /* Touch target sizes for mobile */
        button, select, input { min-height: 44px; }
    </style>
</head>
<body class="text-slate-800">

    <!-- VISTA MAESTRA (ADMIN) -->
    <div id="wrapper-master" class="min-h-screen flex flex-col">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
            <div class="gold-line"></div>
            <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-3">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-slate-900 rounded-lg flex items-center justify-center text-2xl shadow-lg border border-amber-500">üé≠</div>
                    <div>
                        <h1 class="font-serif text-lg md:text-xl font-black text-slate-900 leading-none uppercase">Tesorer√≠a Central</h1>
                        <p class="text-[9px] font-bold text-amber-700 uppercase tracking-[0.2em] mt-1">Paucarbambilla</p>
                    </div>
                </div>
                
                <nav id="main-nav" class="flex items-center gap-1 bg-slate-100 p-1 rounded-xl w-full md:w-auto overflow-x-auto no-scrollbar">
                    <button onclick="router('dashboard', this)" class="nav-btn flex-1 md:flex-none px-3 md:px-5 py-2 text-[10px] md:text-xs font-black rounded-lg transition-all nav-active whitespace-nowrap">DASHBOARD</button>
                    <button onclick="router('integrantes', this)" class="nav-btn flex-1 md:flex-none px-3 md:px-5 py-2 text-[10px] md:text-xs font-black rounded-lg transition-all text-slate-500 whitespace-nowrap">COMPA√ëEROS</button>
                    <button onclick="router('contabilidad', this)" class="nav-btn flex-1 md:flex-none px-3 md:px-5 py-2 text-[10px] md:text-xs font-black rounded-lg transition-all text-slate-500 whitespace-nowrap">LIBRO DIARIO</button>
                </nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 md:p-6 space-y-6 md:space-y-8 flex-1 w-full">
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view-content animate-fade space-y-6">
                <section class="bg-white p-5 md:p-8 rounded-2xl border border-slate-200 shadow-sm border-l-8 border-l-slate-900">
                    <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                        <div>
                            <h2 class="font-serif text-2xl md:text-3xl font-black text-slate-900">Balance Maestro</h2>
                            <p class="text-slate-500 text-xs md:text-sm mt-1">Consolidado de todas las fuentes de ingreso y egreso.</p>
                        </div>
                        <div class="md:text-right w-full md:w-auto bg-slate-50 md:bg-transparent p-3 md:p-0 rounded-xl">
                            <p class="text-[10px] font-black text-slate-400 uppercase">Saldo Actual Real</p>
                            <h3 id="kpi-balance" class="text-3xl md:text-4xl font-black text-slate-900">S/. 0.00</h3>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-6">
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <p class="text-[8px] font-black text-slate-400 uppercase">Compa√±eros</p>
                            <h4 id="kpi-members" class="text-lg font-bold text-slate-800">--</h4>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <p class="text-[8px] font-black text-slate-400 uppercase">Por Validar</p>
                            <h4 id="kpi-pending" class="text-lg font-bold text-amber-600">S/. 0.00</h4>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                            <p class="text-[8px] font-black text-emerald-700 uppercase">Ingresos</p>
                            <h4 id="kpi-incomes" class="text-lg font-bold text-emerald-700">S/. 0.00</h4>
                        </div>
                        <div class="bg-rose-50 p-3 rounded-xl border border-rose-100">
                            <p class="text-[8px] font-black text-rose-700 uppercase">Egresos</p>
                            <h4 id="kpi-expenses" class="text-lg font-bold text-rose-700">S/. 0.00</h4>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                    <div class="bg-white p-5 md:p-8 rounded-2xl border border-slate-200 shadow-sm">
                        <h4 class="font-serif text-base font-bold mb-4">Ingresos por Tipo</h4>
                        <div class="chart-container"><canvas id="barChart"></canvas></div>
                    </div>
                    <div class="bg-white p-5 md:p-8 rounded-2xl border border-slate-200 shadow-sm">
                        <h4 class="font-serif text-base font-bold mb-4">Balance General</h4>
                        <div class="chart-container"><canvas id="donutChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- INTEGRANTES -->
            <div id="view-integrantes" class="view-content hidden animate-fade space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="text-center md:text-left">
                        <h2 class="font-serif text-2xl md:text-3xl font-black text-slate-900">Control de Compa√±eros</h2>
                        <p class="text-slate-500 text-xs">Gesti√≥n de la cuadrilla y enlaces de pago.</p>
                    </div>
                    <button onclick="toggleModal('modal-nuevo', true)" class="w-full md:w-auto bg-slate-900 text-white px-5 py-3 rounded-xl font-bold text-xs hover:bg-black transition shadow-lg">‚ûï AGREGAR COMPA√ëERO</button>
                </div>

                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-400 text-[9px] md:text-[10px] uppercase font-black tracking-widest border-b">
                                <tr>
                                    <th class="px-6 py-4">Compa√±ero</th>
                                    <th class="px-6 py-4">Link WhatsApp</th>
                                    <th class="px-6 py-4 text-center">Acceso</th>
                                </tr>
                            </thead>
                            <tbody id="memberTable" class="divide-y divide-slate-100">
                                <!-- JS Din√°mico -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- LIBRO DIARIO -->
            <div id="view-contabilidad" class="view-content hidden animate-fade space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="text-center md:text-left">
                        <h2 class="font-serif text-2xl md:text-3xl font-black text-slate-900">Libro Diario</h2>
                        <p class="text-slate-500 text-xs italic">Hojas contables por actividades.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                        <select id="filter-ledger" onchange="renderLedger()" class="flex-1 bg-white border border-slate-200 rounded-lg px-3 py-2 text-[10px] font-black outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="todos">Ver Todas las Hojas</option>
                            <option value="compa√±ero">üë§ Aportes Integrantes</option>
                            <option value="actividad">üçó Actividades (Polladas/Parrilladas)</option>
                            <option value="donacion">üéÅ Aportes Extra (Donantes)</option>
                            <option value="auspicio">üè¢ Auspiciadores</option>
                            <option value="egreso">üìâ Egresos / Gastos</option>
                        </select>
                        <button onclick="toggleModal('modal-egreso', true)" class="bg-rose-600 text-white px-4 py-2 rounded-lg text-[10px] font-black hover:bg-rose-700 transition">‚ûñ REGISTRAR GASTO</button>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left excel-table">
                            <thead>
                                <tr class="uppercase tracking-widest">
                                    <th class="px-4 py-3">Fecha</th>
                                    <th class="px-4 py-3">Hoja / Libro</th>
                                    <th class="px-4 py-3">Detalle</th>
                                    <th class="px-4 py-3">Importe</th>
                                    <th class="px-4 py-3 text-center">Estado</th>
                                    <th class="px-4 py-3 text-center">Validar</th>
                                </tr>
                            </thead>
                            <tbody id="ledger-body" class="text-[11px] md:text-sm">
                                <!-- JS Din√°mico -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- VISTA DEL PORTAL INTEGRANTE (MOBILE OPTIMIZED) -->
    <div id="wrapper-member" class="hidden min-h-screen bg-slate-50 pb-12">
        <header class="bg-white border-b border-slate-100 px-4 py-3 flex justify-between items-center shadow-sm sticky top-0 z-50">
            <div class="flex items-center gap-2">
                <span class="text-xl">üé≠</span>
                <span class="font-serif font-black text-slate-800 uppercase text-xs tracking-tight">Portal de Aportes</span>
            </div>
            <button onclick="exitMemberView()" class="text-[9px] font-black bg-slate-100 text-slate-600 px-3 py-2 rounded-lg border">SALIR</button>
        </header>

        <main class="max-w-xl mx-auto p-4 space-y-6 animate-fade">
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-lg border-t-8 border-t-amber-600 text-center relative overflow-hidden">
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Bienvenido Compa√±ero</p>
                <h2 id="member-portal-name" class="font-serif text-2xl font-black text-slate-900 mt-1">--</h2>
                <div id="member-portal-role" class="text-[10px] font-bold text-amber-600 mt-1 uppercase">--</div>
            </div>

            <div class="space-y-6">
                <!-- Voucher Area -->
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm space-y-3">
                    <h3 class="font-black text-[10px] uppercase text-slate-400">1. Subir V√°ucher o Ticket</h3>
                    <div class="relative border-2 border-dashed border-slate-200 rounded-xl p-8 text-center cursor-pointer hover:border-amber-500 transition-all overflow-hidden group" onclick="simulateFileUpload()">
                        <div id="scan-line" class="scan-line"></div>
                        <div id="upload-content">
                            <span class="text-4xl block mb-2">üì∏</span>
                            <p class="text-[10px] font-bold text-slate-600">Click para subir foto</p>
                        </div>
                        <div id="upload-preview" class="hidden">
                            <div class="w-full h-32 bg-slate-100 rounded-xl flex items-center justify-center font-bold text-slate-400 text-[9px] uppercase border">Imagen Cargada</div>
                        </div>
                    </div>
                    <button id="btn-ia" disabled onclick="simulateOCR()" class="w-full py-3 bg-amber-50 text-amber-700 rounded-xl font-black text-[10px] flex items-center justify-center gap-2">
                        ü§ñ LECTURA INTELIGENTE IA
                    </button>
                </div>

                <!-- Form Area -->
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                    <h3 class="font-black text-[10px] uppercase text-slate-400 tracking-widest">2. Detalles del Aporte</h3>
                    <div class="space-y-3">
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-400 ml-1 uppercase">Clasificaci√≥n</label>
                            <select id="mem-type" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-amber-500">
                                <option value="compa√±ero">Cuota del Mes</option>
                                <option value="actividad">Actividad (Pollada/Parrillada)</option>
                                <option value="donacion">Donaci√≥n de Tercero</option>
                                <option value="auspicio">Auspicio</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1">
                                <label class="text-[8px] font-black text-slate-400 ml-1 uppercase">Monto S/.</label>
                                <input type="number" id="mem-amount" placeholder="0.00" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-black outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[8px] font-black text-slate-400 ml-1 uppercase">Fecha</label>
                                <input type="date" id="mem-date" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold outline-none">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[8px] font-black text-slate-400 ml-1 uppercase">Descripci√≥n / Glosa</label>
                            <input type="text" id="mem-ref" placeholder="Ej: Pollada 5 tickets..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold outline-none">
                        </div>
                        <button onclick="submitVoucher()" class="w-full py-4 bg-slate-900 text-white rounded-xl font-black text-xs hover:bg-black transition shadow-xl mt-2 uppercase tracking-wide">Reportar Pago</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALES ADAPTATIVOS -->
    <div id="modal-nuevo" class="fixed inset-0 bg-slate-900/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl border-t-8 border-amber-600 animate-fade">
            <h3 class="font-serif text-xl font-black text-center mb-6">Nuevo Compa√±ero</h3>
            <div class="space-y-4 text-xs font-bold uppercase">
                <input type="text" id="inp-nombre" placeholder="Nombre completo..." class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 outline-none focus:ring-2 focus:ring-amber-500">
                <select id="inp-cargo" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 appearance-none outline-none">
                    <option>Negrito Gu√≠a</option><option>Trasgu√≠a</option><option>Negrito Pampa</option><option>Abanderado</option>
                </select>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="toggleModal('modal-nuevo', false)" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-black text-[10px] uppercase">Cancelar</button>
                <button onclick="addMember()" class="flex-[2] py-3 bg-slate-900 text-white rounded-xl font-black text-[10px] shadow-lg uppercase">Registrar</button>
            </div>
        </div>
    </div>

    <div id="modal-egreso" class="fixed inset-0 bg-slate-900/60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl border-t-8 border-rose-600 animate-fade text-xs uppercase font-bold">
            <h3 class="font-serif text-xl font-black text-center mb-6 text-rose-800">Registrar Gasto</h3>
            <div class="space-y-4">
                <input type="text" id="exp-desc" placeholder="Detalle del gasto..." class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 outline-none">
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="exp-amount" placeholder="S/." class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 outline-none">
                    <input type="date" id="exp-date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 outline-none">
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="toggleModal('modal-egreso', false)" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-black text-[10px] uppercase">Cerrar</button>
                <button onclick="addExpense()" class="flex-[2] py-3 bg-rose-600 text-white rounded-xl font-black text-[10px] shadow-lg uppercase">Guardar Gasto</button>
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS LOCAL ---
        let members = [
            { id: 1, name: 'Carlos Alvarado', role: 'Negrito Gu√≠a', slug: 'carlos-alvarado-pauc' },
            { id: 2, name: 'Marcial Espinoza', role: 'Trasgu√≠a', slug: 'marcial-espinoza-pauc' }
        ];

        let ledger = [
            { id: 101, date: '2024-02-01', name: 'Alquiler Banda', ref: 'Pago Orquesta Fiesta', amount: 800.00, status: 'aprobado', type: 'egreso', book: 'egreso' },
            { id: 102, date: '2024-02-05', name: 'Auspicio Bodega', ref: 'Sponsor Banderola', amount: 200.00, status: 'aprobado', type: 'ingreso', book: 'auspicio' }
        ];

        let currentActiveMember = null;
        let activeCharts = {};

        // --- NAVEGACI√ìN ---
        function router(viewId, btnEl) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            const view = document.getElementById(`view-${viewId}`);
            if (view) view.classList.remove('hidden');

            if (btnEl) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
                btnEl.classList.add('nav-active');
            }

            if (viewId === 'dashboard') updateDashboard();
            if (viewId === 'integrantes') renderMembers();
            if (viewId === 'contabilidad') renderLedger();
        }

        // --- DASHBOARD ---
        function updateDashboard() {
            const approvedMovements = ledger.filter(m => m.status === 'aprobado');
            
            const totalIncomes = approvedMovements.filter(m => m.type === 'ingreso').reduce((s, m) => s + m.amount, 0);
            const totalExpenses = approvedMovements.filter(m => m.type === 'egreso').reduce((s, m) => s + m.amount, 0);
            const balance = totalIncomes - totalExpenses;

            const pendingAmount = ledger.filter(m => m.status === 'pendiente').reduce((s, m) => s + m.amount, 0);

            document.getElementById('kpi-balance').innerText = `S/. ${balance.toFixed(2)}`;
            document.getElementById('kpi-pending').innerText = `S/. ${pendingAmount.toFixed(2)}`;
            document.getElementById('kpi-incomes').innerText = `S/. ${totalIncomes.toFixed(2)}`;
            document.getElementById('kpi-expenses').innerText = `S/. ${totalExpenses.toFixed(2)}`;
            document.getElementById('kpi-members').innerText = `${members.length}`;

            // Datos para gr√°ficos
            const groups = { compa√±ero: 0, actividad: 0, donacion: 0, auspicio: 0 };
            approvedMovements.forEach(m => { if(m.type === 'ingreso') groups[m.book] += m.amount; });

            initCharts(groups, totalIncomes, totalExpenses);
        }

        // --- RENDERIZADO TABLAS ---
        function renderMembers() {
            const table = document.getElementById('memberTable');
            table.innerHTML = '';
            members.forEach(m => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50";
                tr.innerHTML = `
                    <td class="px-6 py-5">
                        <p class="font-black text-slate-800 text-xs">${m.name}</p>
                        <p class="text-[9px] font-bold text-amber-600 uppercase tracking-tighter">${m.role}</p>
                    </td>
                    <td class="px-6 py-5">
                        <div class="flex items-center gap-2">
                            <span class="text-[8px] font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded hidden sm:inline">.../${m.slug}</span>
                            <button onclick="copyToClipboard('${m.slug}')" class="text-[8px] bg-slate-800 text-white px-3 py-1.5 rounded-lg hover:bg-black font-black uppercase">Copiar</button>
                        </div>
                    </td>
                    <td class="px-6 py-5 text-center">
                        <button onclick="enterMemberView(${m.id})" class="text-[9px] font-black bg-amber-50 text-amber-700 px-4 py-2 rounded-lg border border-amber-100 hover:bg-amber-600 hover:text-white transition uppercase whitespace-nowrap">Abonar</button>
                    </td>
                `;
                table.appendChild(tr);
            });
        }

        function renderLedger() {
            const body = document.getElementById('ledger-body');
            const filter = document.getElementById('filter-ledger').value;
            body.innerHTML = '';

            const filteredLedger = filter === 'todos' ? ledger : ledger.filter(l => l.book === filter);

            filteredLedger.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(m => {
                const tr = document.createElement('tr');
                const isPending = m.status === 'pendiente';
                
                const bookLabels = {
                    compa√±ero: 'üë§ Integrante',
                    actividad: 'üçó Actividad',
                    donacion: 'üéÅ Extra',
                    auspicio: 'üè¢ Auspicio',
                    egreso: 'üìâ Gasto'
                };

                tr.innerHTML = `
                    <td class="px-4 py-4 font-mono">${m.date}</td>
                    <td class="px-4 py-4"><span class="text-[9px] font-black uppercase text-slate-500">${bookLabels[m.book]}</span></td>
                    <td class="px-4 py-4">
                        <p class="font-bold text-slate-700 truncate max-w-[120px]">${m.name}</p>
                        <p class="text-[9px] text-slate-400 truncate max-w-[120px]">${m.ref}</p>
                    </td>
                    <td class="px-4 py-4 font-black ${m.type === 'ingreso' ? 'text-emerald-600' : 'text-rose-600'}">S/. ${m.amount.toFixed(2)}</td>
                    <td class="px-4 py-4 text-center">
                        <span class="px-2 py-0.5 rounded-md text-[8px] font-black uppercase ${isPending ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-emerald-100 text-emerald-700 border border-emerald-200'}">
                            ${m.status}
                        </span>
                    </td>
                    <td class="px-4 py-4 text-center">
                        ${isPending ? `<button onclick="approveLedger(${m.id})" class="text-[9px] bg-emerald-600 text-white px-3 py-1.5 rounded-lg font-black shadow-sm">VALIDAR</button>` : '‚úÖ'}
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        // --- L√ìGICA ---
        function approveLedger(id) {
            const entry = ledger.find(l => l.id === id);
            if (entry) {
                entry.status = 'aprobado';
                renderLedger();
                updateDashboard();
            }
        }

        function addMember() {
            const name = document.getElementById('inp-nombre').value;
            const cargo = document.getElementById('inp-cargo').value;
            if (!name) return;
            const slug = name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-') + '-' + Math.floor(Math.random() * 999);
            members.push({ id: Date.now(), name, role: cargo, slug });
            toggleModal('modal-nuevo', false);
            renderMembers();
            document.getElementById('inp-nombre').value = '';
        }

        function addExpense() {
            const desc = document.getElementById('exp-desc').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const date = document.getElementById('exp-date').value || new Date().toISOString().split('T')[0];
            if (!desc || !amount) return;
            ledger.push({ id: Date.now(), date, name: desc, ref: 'Gasto Tesorer√≠a', amount, status: 'aprobado', type: 'egreso', book: 'egreso' });
            toggleModal('modal-egreso', false);
            updateDashboard();
            renderLedger();
            document.getElementById('exp-desc').value = '';
            document.getElementById('exp-amount').value = '';
        }

        function submitVoucher() {
            const amount = parseFloat(document.getElementById('mem-amount').value);
            const bookType = document.getElementById('mem-type').value;
            if (!amount) return;
            ledger.push({
                id: Date.now(),
                date: document.getElementById('mem-date').value || new Date().toISOString().split('T')[0],
                name: currentActiveMember.name,
                ref: document.getElementById('mem-ref').value || `Aporte v√≠a portal`,
                amount, status: 'pendiente', type: 'ingreso', book: bookType
            });
            alert(`Reporte enviado. Tesorer√≠a validar√° tu aporte de S/. ${amount.toFixed(2)}`);
            exitMemberView();
        }

        // --- SIMULACI√ìN PORTAL ---
        function enterMemberView(id) {
            currentActiveMember = members.find(m => m.id === id);
            document.getElementById('wrapper-master').classList.add('hidden');
            document.getElementById('wrapper-member').classList.remove('hidden');
            document.getElementById('member-portal-name').innerText = currentActiveMember.name;
            document.getElementById('member-portal-role').innerText = currentActiveMember.role;
        }

        function exitMemberView() {
            document.getElementById('wrapper-master').classList.remove('hidden');
            document.getElementById('wrapper-member').classList.add('hidden');
            router('dashboard');
        }

        function simulateFileUpload() {
            document.getElementById('upload-content').classList.add('hidden');
            document.getElementById('upload-preview').classList.remove('hidden');
            document.getElementById('btn-ia').disabled = false;
        }

        function simulateOCR() {
            document.getElementById('scan-line').style.display = 'block';
            setTimeout(() => {
                document.getElementById('scan-line').style.display = 'none';
                document.getElementById('mem-amount').value = 50.00;
                document.getElementById('mem-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('mem-ref').value = "OPERACI√ìN BCP: 7421";
            }, 1500);
        }

        // --- UTILS ---
        function toggleModal(id, show) { document.getElementById(id).classList.toggle('hidden', !show); }
        function copyToClipboard(slug) { alert("Link copiado para WhatsApp: paucarbambilla.app/" + slug); }

        function initCharts(groups, ingresos, egresos) {
            if (activeCharts.bar) activeCharts.bar.destroy();
            if (activeCharts.donut) activeCharts.donut.destroy();

            activeCharts.bar = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: ['Compa√±eros', 'Actividad', 'Extra', 'Auspicio'],
                    datasets: [{
                        label: 'Ingresos S/.',
                        data: [groups.compa√±ero, groups.actividad, groups.donacion, groups.auspicio],
                        backgroundColor: '#0F172A',
                        borderRadius: 6
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { font: { size: 9 } } }, x: { ticks: { font: { size: 9 } } } }
                }
            });

            activeCharts.donut = new Chart(document.getElementById('donutChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Ingresos', 'Egresos'],
                    datasets: [{
                        data: [ingresos, egresos],
                        backgroundColor: ['#10b981', '#f43f5e'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, cutout: '75%',
                    plugins: { legend: { position: 'bottom', labels: { font: { size: 10, weight: 'bold' } } } }
                }
            });
        }

        window.onload = () => router('dashboard');
    </script>
</body>
</html>
